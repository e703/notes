# 配置Haproxy代理SSL服务

## 1.需求

为实现如下功能：
1. haproxy转发7层SSL协议；
1. 基于访问地址及服务拆分服务监控；

## 2.配置
由于需对Exchange通过Haproxy服务后的各项服务状态进行监控，同时进行负载分流，故采用七层协议进行服务负载。以下已已获取Exchange的PFX证书为例说明。

1.3 Cert证书准备
1.3.1 根证书
1.3.1.1检查根证书是否包含在主机内：
curl https://mail.alan.corp/owa

1.3.1.2 第三方根证书导入主机
root.cer（根证书） intermediate.cer 中间证书机构
Der格式证书转Base64格式
openssl x509 -in root.cer -inform der -outform pem -out root.pem
openssl x509 -in intermediate.cer -inform der -outform pem -out intermediate.pem 

将颁发证书机构导入本机证书
c_rehash .

cat 4b37341f.0 >> /etc/pki/tls/certs/ca-bundle.crt

1.3.1.3 将Exchange主机私有证书导入本机
mail.pfx（Exchange主机证书带私有证书，导出保存Base64格式）

openssl pkcs12 -in mail.pfx -nocerts -out exchange_private_key_passwordprotected.pem
输入pfx文件密码，输入Pem文件密码（4位以上）
openssl rsa -in exchange_private_key_passwordprotected.pem -out exchange_private_key_nopassword.pem
输入Pem密码
openssl pkcs12 -in mail.pfx -clcerts -nokeys -out exchange_certificate.pem
输入pfx密码
cat exchange_certificate.pem exchange_private_key_nopassword.pem > exchange_certificate_and_key_nopassword.pem

mv exchange_certificate_and_key_nopassword.pem /etc/ssl/certs/










