# 编译部署haproxy
## 1.编译环境准备

mini介质安装Centos7

### 1.1环境准备
```
yum -y update
yum install wget ftp mlocate openssl openssl-devel openssl-perl.x86_64 net-tools gcc automake autoconf libtool make -y
```

关闭SELINUX
```
vi /etc/selinux/config
SELINUX=enforcing改成SELINUX=disabled
getenforce
```

创建系统账号
```
useradd -s /sbin/nologin -M haproxy
id haproxy
```

## 2.编译安装haproxy

### 2.1软件下载编译及安装
软件安装本地源选择tmp目录或其他可读写目录。

`cd /tmp`
下载并解压缩
下载方法01：
```
wget http://www.haproxy.org/download/2.1/src/haproxy-2.1.4.tar.gz
tar -zxvf haproxy-2.1.4.tar.gz
```

下载方法02：
```
curl --progress http://www.haproxy.org/download/2.1/src/haproxy-2.1.4.tar.gz | tar xz

cd haproxy-2.1.4
```

#### 2.1.1配置安装环境并安装
```
Hadir=/data/haproxy #定义变量安装目录
mkdir -p $Hadir
tar -axf haproxy-* && cd ./haproxy-*
make TARGET=linux2628 ARCH=x86_64 PREFIX=$Hadir
make install PREFIX=$Hadir
```

#### 2.1.2 安装验证 
`$Hadir/sbin/haproxy -v`

#### 2.1.3 其他优化

##### 2.1.3.1NAT转发

```
sed -i 's@net.ipv4.ip_forward = 0@net.ipv4.ip_forward = 1@g' /etc/sysctl.conf
grep ip_forward /etc/sysctl.conf
echo "net.ipv4.ip_nonlocal_bind = 1" >>/etc/sysctl.conf #允许没监听IP时启动
sysctl -p
```

##### 2.1.3.2启动脚本配置

```
cp ./examples/haproxy.init $Hadir/haproxy
chmod 755 $Hadir/haproxy
sed -i '/^BIN=/cBIN='$Hadir'/sbin/$BASENAME' $Hadir/haproxy
sed -i '/^CFG=/cCFG='$Hadir'/$BASENAME.cfg' $Hadir/haproxy
```

#### 2.1.3.3日志配置

```
sed -i 's/^#$ModLoad imudp/$ModLoad imudp/g' /etc/rsyslog.conf
sed -i 's/^#$UDPServerRun 514/$UDPServerRun 514/g' /etc/rsyslog.conf
echo 'local0.* /var/log/haproxy.log'>>/etc/rsyslog.conf #添加haproxy日志路径
systemctl restart rsyslog

echo "">$Hadir/haproxy.cfg
```

#### 2.1.3.4 其他

`mkdir -p /var/lib/haproxy`

#2.1.3.5防火墙配置
```
firewall-cmd --permanent --add-port=443/tcp
firewall-cmd --permanent --add-port=80/tcp
firewall-cmd --permanent --add-port=25/tcp
firewall-cmd --permanent --add-port=110/tcp
firewall-cmd --permanent --add-port=143/tcp
firewall-cmd --permanent --add-port=465/tcp
firewall-cmd --permanent --add-port=587/tcp
firewall-cmd --permanent --add-port=993/tcp
firewall-cmd --permanent --add-port=995/tcp
firewall-cmd --permanent --add-port=9000/tcp

systemctl restart firewalld
```

1.3.5 创建配置文件
echo "
###########全局配置#########
    global
    log 127.0.0.1 local0
    log 127.0.0.1 local1 notice
    daemon
    #nbproc 1     #进程数量 
    maxconn 4096  #最大连接数 
    user haproxy  #运行用户  
    group haproxy #运行组 
    chroot /var/lib/haproxy
    pidfile /var/run/haproxy.pid
########默认配置############
    defaults
    log global
    mode http             #默认模式{ tcp|http|health }
    option httplog       #日志类别,采用httplog
    option dontlognull   #不记录健康检查日志信息  
    retries 2            #2次连接失败不可用
    option forwardfor    #后端服务获得真实ip
    option httpclose     #请求完毕后主动关闭http通道
    option abortonclose  #服务器负载很高，自动结束比较久的链接  
    maxconn 4096         #最大连接数  
    timeout connect 5m   #连接超时  
    timeout client 1m    #客户端超时  
    timeout server 31m   #服务器超时  
    timeout check 10s    #心跳检测超时  
    balance roundrobin   #负载均衡方式，轮询
#状态页面控制
listen stats
    bind *:9000 					#伪装的端口号
    mode http						#工作模式
	balance							#负载模式
    stats enable 					#显示状态页面
    stats hide-version 				#隐藏haproxy的版本号
    stats realm HAProxy\ Stats		#提示信息
    stats auth admin:P@44w0rd 		#登录状态页面的帐号和密码
#   stats admin if TRUE 			#状态页面出现管理功能
    stats uri /						#访问入口
	
#转发配置
	# Http 80 负载
		frontend ft_exchange_HTTP
			bind *:80 name web
			maxconn 10000
		default_backend bk_exchange_HTTP

		backend bk_exchange_HTTP
			server Node01 10.101.0.150:80 maxconn 10000 check
			server Node02 10.101.0.151:80 maxconn 10000 check backup

	# Https 443 负载
		frontend ft_exchange_SSL
			bind *:443 name ssl
			maxconn 10000 #alctl: connection max (depends on capacity)
		default_backend bk_exchange_SSL #alctl: default farm to use

		backend bk_exchange_SSL
			server Node01 10.101.0.150:443 maxconn 10000 check
			server Node02 10.101.0.151:443 maxconn 10000 check backup
">$Hadir/haproxy.cfg

------------------------------------------------------------------------


1.4 #启动
/data/haproxy/haproxy start
netstat -antp|grep haproxy
ps -ef|grep haproxy

1.5 #添加自启动
ln -sf /data/haproxy/haproxy /etc/init.d/haproxy
chkconfig --add haproxy
chkconfig haproxy on
chkconfig --list haproxy
service haproxy restart

1.6 重启检查服务状态：
systemctl status haproxy
ps -A |grep haproxy
firewall-cmd --query-port 443/tcp
firewall-cmd --list-services            # 查看开放的服务
firewall-cmd --add-port=3306/tcp        # 开放通过tcp访问3306
firewall-cmd --remove-port=80tcp        # 阻止通过tcp访问3306
firewall-cmd --add-port=233/udp         # 开放通过udp访问233
firewall-cmd --list-ports               # 查看开放的端口


1.7 keepalived配置
安装前环境准备
yum -y install psmisc libnfnetlink-devel curl gcc openssl-devel libnl3-devel net-snmp-devel

1.7.1 下载与安装
软件目录规划
软件安装目录：/data/keepalived

日志文件单独存放在/var/log/keepalived/keepalived.log下

#配置主机名
hostnamectl set-hostname SD-haproxy-01

vi /etc/hosts
# 增加主机地址
10.101.0.150    SD-haproxy-01.localdomain


防火墙放行vrrp组播
firewall-cmd --direct --permanent --add-rule ipv4 filter INPUT 0 --in-interface ens160 --destination 224.0.0.18 --protocol vrrp -j ACCEPT
firewall-cmd --reload

1.7.3开始编译
1.7.3.1下载源码包
 下载站点：
 1、http://www.keepalived.org/download.html
 2、http://keepalived.org/software
 cd /tmp
 curl --progress https://keepalived.org/software/keepalived-2.0.20.tar.gz | tar xz

1.7.3.2 编译
kldir=/data/keepalived #安装目录
mkdir -p $kldir
tar -axf keepalived-* && cd ./keepalived-*
./configure  --prefix=$kldir
make && make install


1.7.3.3自启动脚本
检查脚本信息是否正确
# cat /usr/lib/systemd/system/keepalived.service 
[Unit]
Description=LVS and VRRP High Availability Monitor
After= network-online.target syslog.target
Wants=network-online.target

[Service]
Type=forking
PIDFile=/var/run/keepalived.pid
KillMode=process
EnvironmentFile=-/data/keepalived/etc/sysconfig/keepalived
ExecStart=/data/keepalived/sbin/keepalived $KEEPALIVED_OPTIONS
ExecReload=/bin/kill -HUP $MAINPID

[Install]
WantedBy=multi-user.target

1.7.3.4默认日志文件
!!!!默认的日志存放位置在/var/log/messages中。

echo 'local3.* /var/log/keepalived/keepalived.log' >>/etc/rsyslog.conf                             

1.7.3.5默认启动文件
然后需要修改keepalived.conf
创建默认启动文件
mkdir -p /etc/keepalived
cp /data/keepalived/etc/keepalived/keepalived.conf  /etc/keepalived/
cp /tmp/keepalived-2.0.20/keepalived/etc/init.d/keepalived  /etc/rc.d/init.d/
cp /data/keepalived/etc/sysconfig/keepalived  /etc/sysconfig/

运行如下脚本生成配置文件：
echo "
 
! Configuration File for keepalived

global_defs {
   notification_email {                    #指定keepalived在发生事情的时候，发送邮件告知，可以有多个地址，每行一个.
     ctxadmin@creat-da.com
   }
   notification_email_from SD-Haproxy-MASTER   #指定发件人
   smtp_server 10.101.0.150     #发送email的smtp地址
   smtp_connect_timeout 30       #超时时间
   router_id Haproxy_MASTER      #运行keepalived的机器的一个标识,多个节点标识可以相同，也可以不同
}
vrrp_script check_haproxy {        #killall (安装 yum install psmisc -y)
   script "killall -0 haproxy"
   interval 2
   weighit -2                        #权值脚本成功时（0）等于priority+weghit #否则为priority
   }
vrrp_instance  SD_Haproxy_MASTER {
    state MASTER                    #指定当前节点为主节点 备用节点上设置为BACKUP即可
    interface ens160                #绑定虚拟IP的网络接口
    mcast_src_ip 10.101.0.153       #本机IP地址 
	virtual_router_id 51            #VRRP组名，两个节点的设置必须一样，以指明各个节点属于同一VRRP组
    priority 100                    #主节点的优先级（1-254之间），备用节点必须比主节点优先级低
    advert_int 1                    #设置主备之间的检查时间，单位为s
    authentication {                #设置验证信息，两个节点必须一致
        auth_type PASS
        auth_pass 1024
    }

    unicast_src_ip  10.101.0.153	#配置单播
    unicast_peer {
                    10.101.0.154
    }

    virtual_ipaddress {                      #指定虚拟IP, 两个节点设置必须一样
        10.101.0.111/24 brd 10.101.0.255 dev ens160 label ens160:vip
    }
    track_script {
    check_haproxy
    }
    smtp_alert            #状态切换，使用邮件通知
}

">/etc/keepalived/keepalived.conf
 
重启服务即可。
1.7.3.4 设置开机启动

systemctl enable keepalived.service 




第二台主机修改:
1.主机名：
hostnamectl set-hostname SD-haproxy02

vi /etc/hosts
修改为第二台主机地址

10.101.0.154    SD-haproxy02.localdomain

2.修改IP
vi  /etc/sysconfig/network-scripts/ifcfg-ens160
修改为第二台主机地址
IPADDR=10.101.0.154

service network restart

3.修改keepalived配置

vi /etc/keepalived/keepalived.conf
修改如下行
   smtp_server 10.101.0.151				#发送email的smtp地址
   router_id  Haproxy_BACKUP			#运行keepalived的机器的一个标识,多个节点标识可以相同，也可以不同

vrrp_instance Haproxy_BACKUP {
    state BACKUP					#指定当前节点为主节点 备用节点上设置为BACKUP即可
    priority 99					#主节点的优先级（1-254之间），备用节点必须比主节点优先级低
	
	
	
	
	
	Chrony是NTP的另一种实现方式

## 一、简单介绍：

Chrony是NTP（Network Time Protocol，网络时间协议，服务器时间同步的一种协议）的另一种实现，与ntpd不同，它可以更快且更准确地同步系统时钟，最大程度的减少时间和频率误差。

Chrony包括两个核心组件：

1、chronyd：一个后台运行的守护进程，用于调整内核中运行的系统时钟与NTP服务器同步。它确定服务器增减时间的比率，并对此进行调整补偿；

2、chronyc：提供用户界面，用于监控性能并进行多样化的配置。它可以在chronyd实例控制的服务器上工作，也可以在一台不同的远程服务器上工作。
 
## 二、演示环境：

环境描述：
|IP|主机名|操作系统|服务器角色|描述|时间同步方式|
| ---------- | :-----------:  | :-----------: |:-----------: |:-----------: |:-----------: |
|192.168.1.146|ntp-server|CentOS   7.7|内网NTP Server|向阿里云提供的公网NTP服务器同步时间作为内网NTP Server,内网中的其它服务器向其同步时间|chronyd服务平滑同步|
|192.168.1.147|ntp-client1|CentOS   7.7|	内网NTP Client|向内网NTP Server 192.168.1.146同步时间|chronyd服务平滑同步|
|192.168.1.148|ntp-client2|CentOS   7.7|	内网NTP Client|向内网NTP Server 192.168.1.146同步时间|crontab+ ntpdate强制同步|

备注：使用chronyd服务平滑同步时间的方式要优于crontab + ntpdate，因为ntpdate同步时间会造成时间的跳跃，对一些依赖时间的程序和服务会造成影响，例如：sleep、timer等，且chronyd服务可以在修正时间的过程中同时修正CPU tick。
 
## 三、192.168.1.146配置内网NTP Server：
### 部署过程

#### 1、firewalld防火墙配置

```开放TCP、NTP123端口

#firewall-cmd --permanent --add-port=123/tcp
#firewall-cmd --permanent --add-port=123/udp
```

重新加载防火墙

`#firewall-cmd --reload`

查看防火墙配置

`#firewall-cmd --list-all`

#### 2、关闭SELinux

```
关闭SELINUX
#vi /etc/selinux/config
SELINUX=enforcing改成SELINUX=disabled

之后使用getenforce查看状态
#getenforce
使用它也行
$sestatus
```

#### 3、配置主机名ntp-server：
```
# echo "192.168.1.146 ntp-server" >> /etc/hosts

# vim /etc/hostname --> ntp-server

# hostnamectl set-hostname ntp-server

# logout

Ctrl + Shift + r

# hostname
```

#### 4、查看当前服务器时间：

`# date`
 
#### 5、安装并配置chrony：

`# yum -y install chrony`

编辑配置文件
备份原文件
`# mv /etc/chrony.conf /etc/chrony.conf.bak`
生成新文件
```# vim /etc/chrony.conf，新增如下代码：
# 指定上层NTP服务器为阿里云提供的公网NTP服务器
server ntpapi.bz iburst minpoll 4 maxpoll 10
server ntp1.aliyun.com iburst minpoll 4 maxpoll 10
server ntp2.aliyun.com iburst minpoll 4 maxpoll 10
server ntp3.aliyun.com iburst minpoll 4 maxpoll 10
server ntp4.aliyun.com iburst minpoll 4 maxpoll 10
server ntp5.aliyun.com iburst minpoll 4 maxpoll 10
server ntp6.aliyun.com iburst minpoll 4 maxpoll 10
server ntp7.aliyun.com iburst minpoll 4 maxpoll 10
# 记录系统时钟获得/丢失时间的速率至drift文件中
driftfile /var/lib/chrony/drift
# 如果系统时钟的偏移量大于10秒，则允许在前三次更新中步进调整系统时钟
makestep 10 3
# 启用RTC（实时时钟）的内核同步
rtcsync
# 只允许192.168.1网段的客户端进行时间同步
allow 192.168.1.0/24
# 阿里云提供的公网NTP服务器不可用时，采用本地时间作为同步标准
local stratum 10
# 指定包含NTP验证密钥的文件
keyfile /etc/chrony.keys
# 指定存放日志文件的目录
logdir /var/log/chrony
# 让chronyd在选择源时忽略源的层级
stratumweight 0.05
# 禁用客户端访问的日志记录
noclientlog
# 如果时钟调整大于0.5秒，则向系统日志发送消息
logchange 0.5
备注：详细指令参数可以使用命令# man chrony.conf查看
```
#### 6、启动chronyd服务：

启动服务

`# systemctl start chronyd.service`

查看服务状态

`# systemctl status chronyd.service`

`# ss -tunlp | grep chronyd`

添加至启动

`# systemctl enable chronyd.service`

#### 7、查看时间同步源：

`# chronyc sources -v`
 
`备注：120.25.115.20为ntp1.aliyun.com域名解析后的地址，203.107.6.88为ntp2.aliyun.com~ntp7.aliyun.com域名解析后的地址`

#### 8、查看时间同步源状态：

`# chronyc sourcestats -v`
 
```
备注：可直接输入命令chronyc进入交互式模式
 
常用指令说明：
  help：查看完整的命令帮助列表
  tracking：显示系统时间信息
  activity：检查多少NTP源在线/离线
  add server：手动添加一台新的NTP服务器
  delete：手动移除NTP服务器或对等服务器
  accheck：检查NTP访问是否对特定主机可用
  clients：在客户端报告已访问到的服务器
说明：chronyd和chronyc的详细使用方法可以使用命令# man chronyd和# man chronyc查看
````
 
## 四、192.168.1.147配置内网NTP Client：
1、配置firewalld防火墙
2、关闭SELinux
3、配置主机名ntp-client1：
4、查看当前服务器时间
5、安装并配置chrony：
```
# yum -y install chrony
# mv /etc/chrony.conf /etc/chrony.conf.bak
# vim /etc/chrony.conf，新增如下代码：
server 192.168.1.146 iburst
driftfile /var/lib/chrony/drift
makestep 10 3
rtcsync
local stratum 10
keyfile /etc/chrony.keys
logdir /var/log/chrony
stratumweight 0.05
noclientlog
logchange 0.5
```
6、启动chronyd服务：
```
# systemctl start chronyd.service
# systemctl status chronyd.service
# ss -tunlp | grep chronyd
# systemctl enable chronyd.service
```

7、查看时间同步源：

`# chronyc sources -v`

8、查看时间同步源状态：

`# chronyc sourcestats -v`

## 五、192.168.1.148配置内网NTP Client：
1、关闭firewalld防火墙
2、关闭SELinux
3、配置主机名ntp-client2：
4、查看当前服务器时间：
5、安装ntpdate：

`# yum -y install ntpdate`

6、编写定时任务，实现每3分钟向192.168.1.146同步一次时间，并将系统时间设置为硬件时间
```
# crontab -e --> */3 * * * * /usr/sbin/ntpdate 192.168.1.146 &> /dev/null;/usr/sbin/hwclock -w

# crontab -l

# systemctl enable crond.service
```

7、测试定时任务：将时间调慢，观察服务器时间是否会自动同步
 
8、检查3台服务器的时间是否一致：
 
 





